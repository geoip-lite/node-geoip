const{open:e,fstat:t,read:r,close:n,openSync:i,fstatSync:o,readSync:a,closeSync:l}=require('node:fs'),{join:f,resolve:u}=require('node:path'),{isIP:c}=require('node:net'),s=require('async'),{aton4:d,aton6:B,cmp6:y,ntoa4:I,ntoa6:E,cmp:g}=require('./utils.js'),m=require('./fsWatcher.js'),{version:S}=require('../package.json'),z='dataWatcher',p=u(__dirname,global.geoDataDir||process.env.GEODATADIR||'../data/'),P={city:f(p,'geoip-city.dat'),city6:f(p,'geoip-city6.dat'),cityNames:f(p,'geoip-city-names.dat'),country:f(p,'geoip-country.dat'),country6:f(p,'geoip-country6.dat')},h=[[d('10.0.0.0'),d('10.255.255.255')],[d('172.16.0.0'),d('172.31.255.255')],[d('192.168.0.0'),d('192.168.255.255')]],F={firstIP:null,lastIP:null,lastLine:0,locationBuffer:null,locationRecordSize:88,mainBuffer:null,recordSize:24},L={firstIP:null,lastIP:null,lastLine:0,mainBuffer:null,recordSize:48};let U={...F},D={...L};const N=e=>{const t=e.indexOf('\0');return-1===t?e:e.substring(0,t)},T=(e,t,r,n)=>{const i=[];for(let o=0;o<2;o++)i.push(e.readUInt32BE(t*r+16*n+4*o));return i},w=e=>{let t,r,n=0,i=U.lastLine,o=U.lastIP,a=U.firstIP;const l=U.mainBuffer,f=U.locationBuffer,u=h,c=U.recordSize,s=U.locationRecordSize,d={range:[null,null],country:'',region:'',eu:'',timezone:'',city:'',ll:[null,null],metro:null,area:null};if(e>U.lastIP||e<U.firstIP)return null;for(let t=0;t<u.length;t++)if(e>=u[t][0]&&e<=u[t][1])return null;for(;;){t=Math.round((i-n)/2)+n;const u=t*c;if(o=l.readUInt32BE(u),a=l.readUInt32BE(u+4),o<=e&&a>=e){if(d.range=[o,a],10===c)d.country=l.toString('utf8',u+8,u+10);else if(r=l.readUInt32BE(u+8),-1>>>0>r){const e=r*s;d.country=N(f.toString('utf8',e,e+2)),d.region=N(f.toString('utf8',e+2,e+5)),d.metro=f.readInt32BE(e+5),d.ll[0]=l.readInt32BE(u+12)/1e4,d.ll[1]=l.readInt32BE(u+16)/1e4,d.area=l.readUInt32BE(u+20),d.eu=N(f.toString('utf8',e+9,e+10)),d.timezone=N(f.toString('utf8',e+10,e+42)),d.city=N(f.toString('utf8',e+42,e+s))}return d}if(n===i)return null;n===i-1?t===n?n=i:i=n:o>e?i=t:a<e&&(n=t)}},A=['0:0:0:0:0:FFFF:','::FFFF:'];function q(f){let u,c;const d={...F};if('function'==typeof arguments[0])s.series([i=>{s.series([t=>{e(P.cityNames,'r',(e,r)=>{u=r,t(e)})},e=>{t(u,(t,r)=>{c=r.size,d.locationBuffer=Buffer.alloc(c),e(t)})},e=>{r(u,d.locationBuffer,0,c,0,e)},e=>{n(u,e)},t=>{e(P.city,'r',(e,r)=>{u=r,t(e)})},e=>{t(u,(t,r)=>{c=r.size,e(t)})}],r=>{if(r){if('ENOENT'!==r.code&&'EBADF'!==r.code)throw r;e(P.country,'r',(e,r)=>{e?i(e):(u=r,t(u,(e,t)=>{c=t.size,d.recordSize=10,i()}))})}else i()})},()=>{d.mainBuffer=Buffer.alloc(c),s.series([e=>{r(u,d.mainBuffer,0,c,0,e)},e=>{n(u,e)}],e=>{e||(d.lastLine=c/d.recordSize-1,d.lastIP=d.mainBuffer.readUInt32BE(d.lastLine*d.recordSize+4),d.firstIP=d.mainBuffer.readUInt32BE(0),U=d),f(e)})}]);else{try{if(u=i(P.cityNames,'r'),c=o(u).size,0===c)throw{code:'EMPTY_FILE'};U.locationBuffer=Buffer.alloc(c),a(u,U.locationBuffer,0,c,0),l(u),u=i(P.city,'r'),c=o(u).size}catch(e){if('ENOENT'!==e.code&&'EBADF'!==e.code&&'EMPTY_FILE'!==e.code)throw e;u=i(P.country,'r'),c=o(u).size,U.recordSize=10}U.mainBuffer=Buffer.alloc(c),a(u,U.mainBuffer,0,c,0),l(u),U.lastLine=c/U.recordSize-1,U.lastIP=U.mainBuffer.readUInt32BE(U.lastLine*U.recordSize+4),U.firstIP=U.mainBuffer.readUInt32BE(0)}}function O(f){let u,c;const d={...L};if('function'==typeof arguments[0])s.series([r=>{s.series([t=>{e(P.city6,'r',(e,r)=>{u=r,t(e)})},e=>{t(u,(t,r)=>{c=r.size,e(t)})}],n=>{if(n){if('ENOENT'!==n.code&&'EBADF'!==n.code)throw n;e(P.country6,'r',(e,n)=>{e?r(e):(u=n,t(u,(e,t)=>{c=t.size,d.recordSize=34,r()}))})}else r()})},()=>{d.mainBuffer=Buffer.alloc(c),s.series([e=>{r(u,d.mainBuffer,0,c,0,e)},e=>{n(u,e)}],e=>{e||(d.lastLine=c/d.recordSize-1,D=d),f(e)})}]);else{try{if(u=i(P.city6,'r'),c=o(u).size,0===c)throw{code:'EMPTY_FILE'}}catch(e){if('ENOENT'!==e.code&&'EBADF'!==e.code&&'EMPTY_FILE'!==e.code)throw e;u=i(P.country6,'r'),c=o(u).size,D.recordSize=34}D.mainBuffer=Buffer.alloc(c),a(u,D.mainBuffer,0,c,0),l(u),D.lastLine=c/D.recordSize-1}}module.exports={cmp:g,lookup:e=>{if(!e)return null;if('number'==typeof e)return w(e);if(4===c(e))return w(d(e));if(6===c(e)){const t=(e=>{const t=e.toUpperCase();for(let e=0;e<A.length;e++){const r=A[e];if(0===t.indexOf(r))return t.substring(r.length)}return null})(e);return t?w(d(t)):(e=>{const t=D.mainBuffer,r=D.recordSize,n=U.locationBuffer,i=U.locationRecordSize,o={range:[null,null],country:'',region:'',city:'',ll:[0,0],metro:null,area:null,eu:'',timezone:''};D.lastIP=T(t,D.lastLine,r,1),D.firstIP=T(t,0,r,0);let a,l,f=0,u=D.lastLine,c=D.lastIP,s=D.firstIP;if(y(e,D.lastIP)>0||y(e,D.firstIP)<0)return null;for(;;){if(a=Math.round((u-f)/2)+f,c=T(t,a,r,0),s=T(t,a,r,1),y(c,e)<=0&&y(s,e)>=0){const e=a*r;if(34===r)o.country=N(t.toString('utf8',e+32,e+34));else if(l=t.readUInt32BE(e+32),-1>>>0>l){const r=l*i;o.country=N(n.toString('utf8',r,r+2)),o.region=N(n.toString('utf8',r+2,r+5)),o.metro=n.readInt32BE(r+5),o.ll[0]=t.readInt32BE(e+36)/1e4,o.ll[1]=t.readInt32BE(e+40)/1e4,o.area=t.readUInt32BE(e+44),o.eu=N(n.toString('utf8',r+9,r+10)),o.timezone=N(n.toString('utf8',r+10,r+42)),o.city=N(n.toString('utf8',r+42,r+i))}return o}if(f===u)return null;f===u-1?a===f?f=u:u=f:y(c,e)>0?u=a:y(s,e)<0&&(f=a)}})(B(e))}return null},pretty:e=>'string'==typeof e?e:'number'==typeof e?I(e):Array.isArray(e)?E(e):e,startWatchingDataUpdate:e=>{m.makeFsWatchFilter(z,p,6e4,async()=>{await s.series([e=>{q(e)},e=>{O(e)}],e)})},stopWatchingDataUpdate:()=>m.stopWatching(z),clear:()=>{U={...F},D={...L}},reloadDataSync:()=>{q(),O()},reloadData:async e=>{await s.series([e=>{q(e)},e=>{O(e)}],e)},version:S},q(),O();